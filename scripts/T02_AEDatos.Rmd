---
title: "Analisis Estadistico de Datos"
author: "Grupo 05"
date: "2025-05-04"
output:
  html_document:
    toc: true
    toc_float: true
    theme: cosmo
  pdf_document:
    toc: true
output_dir: "/Users/aosoriom/Repos/MER_AEDatos/docs" 
---

<!-- Para dejar limitadores visuales (lineas divisorias) usar ________________  -->
<!-- Para dejar un salto de linea se deja un doble espacio al final  -->
<!-- con toc_float: true la table of contents queda a la izquierda   -->
<!-- con rmarkdown::render("scripts/02.Rmd", output_dir = "docs") se logro poner el html en /docs 1 vez   -->

________________  

# Taller 02
**Multivariada**   
**Maestría en Energías Renovables**  
**Escuela de Ingeniería, Ciencia y Tecnología**  
**Universidad del Rosario**  
**Integrantes:**  
Zahira Itzel González Cleves  
Diego Alejandro Mejía Montañez  
Daniel Felipe Russi Aragón  
Iván Camilo Granados Niño  
Andrés Alfonso Osorio Marulanda

________________  
```{r setup, echo=FALSE, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Desarrollo Taller

```{r leer dataset, results='asis', message=FALSE, warning=FALSE}

library(devtools)
library(dplyr)
library(factoextra)
library(ggExtra)
library(ggplot2)
library(kableExtra)
library(knitr)
library(MASS)
library(plotly)
library(psych)
library(tidyverse)
library(usethis)

#carga de datos separados con sep=; 
df_pais = read.table("/Users/aosoriom/Repos/MER_AEDatos/datasets/datos_taller_02.csv",sep=";",header = TRUE)

# Visualiza la tabla de datos de mejor manera y con scroll
# Para tablas pequeñas usar: kable(head(mi_dataframe), caption = "Primeras filas del dataset")
kable(head(df_pais), caption = "Primeras filas del dataset") %>%
  scroll_box(width = "100%", height = "auto")
summary(df_pais)
```

```{r tabla-scroll-kableExtra, echo=FALSE, message=FALSE, warning=FALSE}

```

## Normal Multivariada
________________  

### Pregunta 1 Daniel
$w_1=5$  

Encuentre la estimación del vector de medias y la matriz de varianzas y covarianzas para 5 variables de su interés del conjunto de datos.

## ACP
________________ 

### Pregunta 2 Daniel 
$w_2=5$  

Realice un análisis descriptivo univariado y bivariado del conjunto de datos. Considere nuevamente las mismas 5 variables de su interés para este punto.





### Pregunta 3 Ivan
$w_3=8$  
El conjunto de datos incluye 57 variables, analizarlas de forma individual podría representar un gasto computacional y de tiempo bastante agotador; por lo cuál una técnica de reducción de dimensionalidad sería ideal. Ejecute un ACP sobre estos datos, compare la contribución de las variables sobre el primer plano factorial de un ACP normado (escalado) y uno sin normalizar (sin escalar).

El conjunto de datos incluye 57 variables, analizarlas de forma individual podría representar un gasto computacional y de tiempo bastante agotador; por lo cual una técnica de reducción de dimensionalidad sería ideal. Ejecute un ACP sobre estos datos, compare la contribución de las variables sobre el primer plano factorial de un ACP normado (escalado) y uno sin normalizar (sin escalar).

```{r preg_03, message=FALSE, warning=FALSE}
#carga de datos separados con sep=; 
pais = read.table("/Users/aosoriom/Repos/MER_AEDatos/datasets/datos_taller_02.csv",sep=";",header = TRUE)

#se crea el data frame país 
datos<-as.data.frame(pais) 

#nueva variable y se le quita la 1ra columna 
columnas_a_convertir <- names(datos)[-1] 

#transformación de datos a numéricos str(Datos)
datos[columnas_a_convertir] <- lapply(datos[columnas_a_convertir], as.numeric)
# str(datos) --> se comenta para no sacar todos los datos, se debe quitar.

#selección de las 5 variables
select_data <- datos[, c("Refined_petroleum_products_consumption_TBPD", "Refined_petroleum_products_production_TBPD", "Electricity_exports_BKWH", "Electricity_imports_BKWH", "Electricity_installed_capacity_MK")]
summary(select_data)
 
#se excluye la primera columna
columnas_numericas <- names(datos)[-1]
 
#se aplica pca a datos normalizados o escalados
 
#"prcom()p" es la forma rápida de implementar un PCA sobre un conjunto de datos, es necesaria la biblioteca stats, center y SCALE TRUE corresponden a las medias y desv estándar antes de aplicar el PCA
pca_normalizado <- prcomp(datos[, columnas_numericas], center = TRUE, scale = TRUE)
 
#se aplica pca a datos sin normalizar
pca_sin_normalizar <- prcomp(datos[, columnas_numericas], center = FALSE, scale = FALSE)
 
#se comparan las contirbuciones de las variables seleccionadas
contribucion_normalizado <- pca_normalizado$sdev^2
contribucion_sin_normalizar <- pca_sin_normalizar$sdev^2
 
#creación de tabla de datos para luego ver las contribuciones
contribuciones_df <- data.frame(
  Contribucion_Normalizado = contribucion_normalizado,
  Contribucion_Sin_Normalizar = contribucion_sin_normalizar)

```

Con las variables seleccionadas que presentan valores bajos con respecto a otros países se observa que las contribuciones tienen poca influencia en la variación de los datos después de ser normalizados, por lo que se puede decir que dichas variables no contribuyen con aportes significativos al primer componente principal con datos escalados. 
  
Para los datos sin normalizar, las contribuciones son mayores comparadas con las normalizadas debido a los rangos o escalas de las variables seleccionadas no normalizadas.

### Pregunta 4 Andres
$w_4=8$  
Una vez calculado el PCA normado, ¿qué número de componentes principales deberíamos seleccionar? ¿Bajo que criterio seleccionó este número de componentes?



### Pregunta 5 Diego
$w_5=8$  
Analice la representación de las variables originales sobre las dos primeras componentes en el primer plano factorial. ¿Que conclusiones podemos sacar de este análisis?

```{r preg_05a, message=FALSE, warning=FALSE}
#agrupa los datos por componentes principales escalados y los guarda en la variable asignada acp_c (para reducir el tamaño del nombre de las variables se utiliza IA)
# La sintaxis [, -1] selecciona todas las filas (espacio antes de la coma)
# y todas las columnas excepto la columna en el índice 1 (el -1 después de la coma)
datos_rec <- read.table("/Users/aosoriom/Repos/MER_AEDatos/datasets/datos_taller_02_rec.csv",sep=";",header = TRUE)
datos_solo_numericos <- datos_rec[, -1]
acp_c <-prcomp(datos_solo_numericos, scale = TRUE)

fviz_pca_var(acp_c,axes=c(1,2),repel=TRUE)
```

En el siguiente diagrama fasorial se grafican los 2 componentes principales, la misma es un poco difusa porque se están graficando las 57 variables.

Por esto se procede a graficar únicamente las 30 variables que más aportan a los datos como se aconseja en la sección de ayuda, mediante  `fviz_pca_var(acp_c,axes=c(1,2),repel=TRUE,select.var = list(contrib = 30))` obteniendo la siguiente grafica, de esta podemos concluir que dimension 1 o PCA 1, agrupa el 62% de los datos y el PCA 2 el 7,7%, siendo necesario apoyarnos en mas PCAs para lograr tomar un 80% de los datos y tener una mejor representacion de los datos de las 57 variables. Por otro lado, las flechas asignadas para cada variable indican la contribución en cada PCA, dando como resultado que en su mayoria aportan a la dimension 1 con una longitud muy parecida o agrupada entre cada variable dado que eliminamos las que menos contribuían, teniendo 2 casos visiblemente diferentes como lo son las variables Hid_Bom_Gen ( Hydroelectric_pumped_storage_electricity_net_generation_BKWH), la cual se ubica en el cuadrante 2 aportanto al PCA1 negativo, y la variable NG_Lq_Pro (Natural_gas_plant_liquids_production_TBPD), la cual aporta en la dimension 1 y 2.

### GRAF05_1

En contraste al ejercicio de clase, en este contamos con una cantidad mayor de componentes relevantes para el análisis, por lo cual, realice el mismo gráfico anterior pero ahora sobre el plano factorial conformado por los componentes 2 y 3. ¿Qué conclusiones podemos sacar de este gráfico?

Utilizando la linea de codigo `fviz_pca_var(acp_c, axes = c(2, 3),repel=TRUE,select.var = list(contrib = 30))`, Los datos de las variables en estos componentes tienen una menor contribución y estos se puede evidenciar en la magnitud de las flechas, junto a esto, se puede ver que hay una mayor distribución en los diferentes cuadrantes del diagrama fasorial, es importante resaltar como el PCA3 tiene 7% de los datos, con estos 3 PCAs agruparíamos el 76.7% de los datos, sería necesario tomar más componentes principales para llegar al 80%, lo cual nos daría una representación objetiva de los datos.

### GRAF05_2

### Pregunta 6 Daniel
$w_6=10$  
Ahora examine con detenimiento el mapa de individuos sobre los planos factoriales que conforman las componentes (1,2) y (2,3). ¿Qué conclusiones puede sacar según la cercanía de algunas UE?




### Pregunta 7 Ivan
$w_7=10$  
Como hemos observado en clase, el ACP es una técnica bastante sensible a datos atípicos, ejecute nuevamente el ACP retirando del conjunto de datos a Estados Unidos, China, Arabia Saudi y Rusia. ¿En que cambia el ACP al excluir estos países?. ¿Se perciben clusters de países con mayor claridad?. Calcule únicamente el ACP normado.

```{r preg_07, message=FALSE, warning=FALSE}
#se retiran los países propuestos
retirados <- c("UnitedStates", "China", "SaudiArabia", "Russia")
 
#creación de la nueva tabla de datos que ya no tienen los países retirados
paises_filtrados <- datos[!datos$Country %in% retirados, ]
columnas_numericas <- names(paises_filtrados)[-1]
 
pca_normalizado <- prcomp(paises_filtrados[, columnas_numericas], center = TRUE, scale = TRUE)
pca_sin_normalizar <- prcomp(paises_filtrados[, columnas_numericas], center = FALSE, scale = FALSE)
 
contribucion_normalizado <- pca_normalizado$sdev^2
contribucion_sin_normalizar <- pca_sin_normalizar$sdev^2

contribuciones_df <- data.frame(
  Contribucion_Normalizado = contribucion_normalizado,
  Contribucion_Sin_Normalizar = contribucion_sin_normalizar
)
 
varianza_explicada <- pca_normalizado$sdev^2
 
varianza_acumulada <- cumsum(varianza_explicada) / sum(varianza_explicada)
 
head(contribuciones_df)
```

Los países retirados presentan datos atípicos ya que son grandes consumidores de recursos energéticos como la electricidad o el petróleo y por otra parte, también se tienen grandes productores de aquellos recursos.
 
Las variaciones de las contribuciones de los datos normalizados si se comparan con los primeros resultados cuando estaban todos los países, muestran menos saltos, de manera similar sucede con los datos sin normalizar.
  
Lo anterior debido a que los países retirados presentaban datos altos si se comparaban con otros, lo que hacía que la escala de datos fuera mucho mayor. 
Al ser retirados estos países con datos atípicos, contribuye a buscar más eficazmente países con comportamientos más comunes entre sí y permite sean agrupados de o subdivididos de manera geográfica, por ejemplo.  


## Clustering
________________ 
Los puntos 8 a 11 se realizarán excluyendo de la base de datos los países atípicos mencionados en el punto 7 (es decir, retirando ‘UnitedStates’,‘China’,‘SaudiArabia’,‘Russia’).

### Pregunta 8 Zahira
$w_8=8$  
De acuerdo a lo aprendido en la clase de agrupamiento, utilice el primer plano factorial para determinar de manera aproximada el número de grupos en el análisis. ¿Cuántos clusters espera que existan en el conjunto de datos?

```{r preg_08, message=FALSE, warning=FALSE}
PrimerasComponentes <- pca_normalizado$x[, c(1, 2)] #Seleccion de la ubicación de cada país en las dos componentes principales
distancia_total <- numeric(10)  # Crear vector de longitud 10

for (i in 1:10) 
  {
    kmeans_model <- kmeans(PrimerasComponentes, centers = i) #agrupar los datos ubicados en el plano en i cantidad de grupos
    distancia_total[i] <- kmeans_model$tot.withinss #sumar la distancia total de la agrupación i
  } 
  plot(1:10,distancia_total,ylab="Distancia por número de grupos", xlab = '1:10', type='b')
```

De acuerdo con la imagen anterior, se pueden esperar 4 clústeres o grupos ya que con esta cantidad se obtiene una reducción de distancia significativa y con cantidades mayores las reducciones son pequeñas.

### Pregunta 9 Andres
$w_9=12$  
Mediante el método de reducción de varianza explicada, determine un número fijo de clusters para su análisis. No tiene que ser el mismo número que el elegido por su compañero, recuerde que ninguno conoce las etiquetas reales de los grupos de los países.


### Pregunta 10 Diego
$w_{10}=12$  
Determine mediante k-means y aglomeración jerárquica (usando enlace promedio) la clasificación en grupos para los países de estudio. Considere todas las variables de estudio ¿son diferentes los resultados de los dos análisis cluster?

```{r preg_10a, message=FALSE, warning=FALSE}
kmeans_m <- kmeans(pca_normalizado$x, centers = 4)# aplicar K-means con 4 clusters
clusters <- kmeans_m$cluster 

 # mostrar tabla con los 4 clusters
 table(clusters)
```

```{r preg_10b, message=FALSE, warning=FALSE}
# aplicar metodo de aglomeracion promedio
d_aglomerados <- hclust(dist(pca_normalizado$x), method = "average")

#lleva el arbol jerarquico a 4 grupos para poder comparar con el resultado de kmeans
clusters_aglomerados <- cutree(d_aglomerados, k = 4) 

#resultados de de los 4 grupos aglomerados
table(clusters_aglomerados) 
```

Si, Son diferentes los resultados entre k-means y aglomeración jerárquica promedio, podemos observar en los resultados que en el caso de K-means el cluster 3 contiene 87 paises, y en el caso de agrupamiento promedio, el grupo 3 contiene 2 paises. El agrupamiento jerarquico promedio agrupa 101 países en el grupo 1, como se vio en clase, los diferentes métodos de agrupamiento (clusters) difieren al momento de tomar las distancias entre los diferentes valores para irlos agrupando, lo cual queda demostrado en la comparación de los resultados anteriores.

### Pregunta 11 Zahira
$w_{11}=12$  
Grafique mediante boxplot la distribución de las 5 variables seleccionadas en el punto 2 diferenciando por los grupos encontrados mediante k-means (es decir, obtenga un boxplot por variable y por grupo: si por ejemplo k-means indica un total de 3 grupos, realice 3 boxplots, uno por grupo, para cada una de las 5 variables). ¿Observa diferencias importantes entre las distribuciones por grupos de la misma variable?

```{r preg_11a, message=FALSE, warning=FALSE}
Variables_Escogidas = paises_filtrados[, c("Country" ,"Refined_petroleum_products_consumption_TBPD", "Refined_petroleum_products_production_TBPD", "Electricity_exports_BKWH", "Electricity_imports_BKWH", "Electricity_installed_capacity_MK")]
Variables_Escogidas$Grupo <- Cluster_4 # agregar al set de datos una columna con el grupo

# boxplot de Refined_petroleum_products_consumption_TBPD
ggplot(Variables_Escogidas, aes(x = factor(Grupo), y = Refined_petroleum_products_consumption_TBPD)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    title = "Consumo de derivados de petróleo por grupo",
    x = "Grupo",
    y = "Consumo (TBPD)" )

# boxplot de Refined_petroleum_products_production_TBPD
ggplot(Variables_Escogidas, aes(x = factor(Grupo), y = Refined_petroleum_products_production_TBPD)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    title = "Producción de derivados de petróleo por grupo",
    x = "Grupo",
    y = "Producción (TBPD)" )

# boxplot de Electricity_exports_BKWH
ggplot(Variables_Escogidas, aes(x = factor(Grupo), y = Electricity_exports_BKWH)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    title = "Exportaciones de electricidad",
    x = "Grupo",
    y = "Exportación (BKWH)")

# boxplot de Electricity_imports_BKWH
ggplot(Variables_Escogidas, aes(x = factor(Grupo), y = Electricity_imports_BKWH)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    title = "Importaciones de electricidad",
    x = "Grupo",
    y = "Importación (BKWH)")

# boxplot de Electricity_installed_capacity_MK
ggplot(Variables_Escogidas, aes(x = factor(Grupo), y = Electricity_installed_capacity_MK)) +
  geom_boxplot() +
  theme_minimal() +
  labs(
    title = "Capacidad instalada",
    x = "Grupo",
    y = "Capacidad instalada (MK)")

```


## Referencias

1. [Introduction to R markdown](https://rmarkdown.rstudio.com/articles_intro.html) 
1. MarkDown Guide - [Basic Syntax](https://www.markdownguide.org/basic-syntax/)
1. [Data Visualization CheatSheet](https://github.com/rstudio/cheatsheets/blob/main/data-visualization.pdf)
1. [Repositorio](https://github.com/aosoriom7/MER_AED_2025I) del Taller en Github
1. [Pagina](https://aosoriom7.github.io/MER_AED_2025I/scripts/02.html) web del taller en Gihub Pages


